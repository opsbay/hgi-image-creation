{
    "min_packer_version": "0.9.0",
    "variables": {
        "image_name": null,
        "source_image": "{{ env `PACKER_SOURCE_IMAGE` }}",
        "source_image_username": "{{ env `PACKER_SOURCE_IMAGE_USERNAME` }}",
        "os_security_groups": "{{ env `PACKER_OS_SECURITY_GROUPS` }}",
        "os_flavor": "{{ env `PACKER_OS_FLAVOR` }}",
        "os_floating_ip_pool": "{{ env `PACKER_OS_FLOATING_IP_POOL` }}",
        "ansible_inventory_groups": "{{ env `PACKER_ANSIBLE_INVENTORY_GROUPS` }}",
        "ansible_config_file": "ansible-minimal.cfg"
    },
    "builders": [
        {
            "image_name": "{{ user `image_name` }}",
            "flavor": "{{ user `os_flavor` }}",
            "floating_ip_pool": "{{ user `os_floating_ip_pool` }}",
            "security_groups": "{{ user `os_security_groups` }}",
            "source_image": "{{ user `source_image` }}",
            "ssh_pty": false,
            "ssh_username": "{{ user `source_image_username` }}",
            "type": "openstack",
            "use_floating_ip": "true"
        }
    ],
    "provisioners": [
        {
            "type": "shell",
            "execute_command": "sudo -S sh -c '{{ .Vars }} {{ .Path }}'",
            "inline": ["apt-get update", "apt-get install -y --no-install-recommends python"]
        },
        {
            "type": "ansible",
            "playbook_file": "{{ template_dir }}/ansible/site.yml",
            "groups": "image-building,{{ user `ansible_inventory_groups` }}",
            "use_sftp": true,
            "user": "ubuntu"
        },
        {
            "type": "shell",
            "execute_command": "sudo -S sh -c '{{ .Vars }} {{ .Path }}'",
            "scripts": [
                "{{ template_dir }}/scripts/minimize.sh"
            ]
        }
    ]
}
